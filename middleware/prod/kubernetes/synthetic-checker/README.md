# Synthetic Checker

##  Checks with Python
Very simple Python application used for running simple synthetic checks. Doing this with a SaaS tool is usually expensive and requires setting up an external connection for private service, we can do it by setting up agent but the management cost of this alone should be similar to maintaining this script running on Kuberntes or as an added Ansible role in a bastion host.
. At the moments it includes:
    - Simple https response code status
    - Structured json logging
    - Basic Liveness/Readyness checks (Not implemented)
    

### Set the environment

    virtualenv env
    source env/bin/activate
    pip install -r app/requirements.txt
    source .env
    aws sso login
   

### Run locally
    python main.py
    
    {"event": {"check_name": "cmapp.sd-prd.bairesdev.net", "endpoint": "https://cmapp.sd-prd.bairesdev.net:443/login", "status_code": 200, "source_id": "Env var not set", "message": "Omitted"}, "level": "info", "ts": "2024-08-29T13:10:12.728046Z"}



### Build image locally
    docker login -u AWS -p $(aws ecr get-login-password) ${AWS_REGISTRY_URL}
    cd app/
    docker build -t ${AWS_REGISTRY_URL}/${ECR_REPO}:latest .
    
### Run locally with docker
    docker run  ${AWS_REGISTRY_URL}/${ECR_REPO}:latest


### Upload image to ECR
    docker push ${AWS_REGISTRY_URL}/${ECR_REPO}:latest

### Deploy cronjob to a K8s cluster

Deploy the Kubernetes artifacts:
    
    cd kubernetes/<env>
    kubectl apply -f .

Update the Kubernetes object:

    cd kubernetes/<env>
    kubectl delete -f cronjob.yaml
    kubectl apply -f .

### Update Checklist
Simply add the check defining a check in the format suggested in the first line of the list.
    
### Check logs in Opensearch:

Use this dashboard to visualize the logs generated by synthetic-checkers:
https://opensearch.dev.sample-domain.io/_dashboards/app/dashboards?security_tenant=global#/view/26e91960-63d1-11ef-b0a6-bdedb340f748?_g=(filters%3A!()%2CrefreshInterval%3A(pause%3A!t%2Cvalue%3A0)%2Ctime%3A(from%3Anow-15m%2Cto%3Anow))
    
    
